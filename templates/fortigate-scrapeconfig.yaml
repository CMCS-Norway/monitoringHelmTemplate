{{- if and .Values.fortigateExporter.enabled .Values.fortigateExporter.scrapeConfig.enabled }}
apiVersion: monitoring.coreos.com/v1alpha1
kind: ScrapeConfig
metadata:
  name: {{ .Values.fortigateExporter.scrapeConfig.name }}
  namespace: {{ include "monitoring-stack.namespace" . }}
  labels:
    {{- include "monitoring-stack.labels" . | nindent 4 }}
    {{- with .Values.fortigateExporter.scrapeConfig.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    scrape: config
    component: fortigate-exporter
spec:
  jobName: {{ .Values.fortigateExporter.scrapeConfig.jobName }}
  metricsPath: {{ .Values.fortigateExporter.scrapeConfig.metricsPath }}
  scrapeInterval: {{ .Values.fortigateExporter.scrapeConfig.scrapeInterval }}
  scrapeTimeout: {{ .Values.fortigateExporter.scrapeConfig.scrapeTimeout }}
  staticConfigs:
    - targets:
        {{- toYaml .Values.fortigateExporter.scrapeConfig.targets | nindent 8 }}
      labels:
        namespace: {{ include "monitoring-stack.namespace" . }}
        customer: {{ .Values.global.customerLabel | quote }}
        platform: {{ .Values.global.platform }}
        provider: {{ .Values.global.provider }}
  relabelings:
    - action: replace
      sourceLabels: [__address__]
      targetLabel: __param_target
    - action: replace
      targetLabel: __address__
      replacement: {{ .Values.fortigateExporter.name | default "fortigate-exporter" }}.{{ include "monitoring-stack.namespace" . }}.svc.cluster.local:{{ dig "service" "port" 80 .Values.fortigateExporter }}
    - action: replace
      sourceLabels: [__param_target]
      targetLabel: hostname
      regex: "https?://([^:/]+).*"
{{- end }}
